<%- include('header')%>

    <!-- End Header Area -->

    <!-- Start Banner Area -->
    <section class="banner-area organic-breadcrumb">
        <div class="container">
            <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
                <div class="col-first">
                    <h1>Checkout</h1>
                    <nav class="d-flex align-items-center">
                        <a href="index.html">Home<span class="lnr lnr-arrow-right"></span></a>
                        <a href="single-product.html">Checkout</a>
                    </nav>
                </div>
            </div>
        </div>
    </section>
    <!-- End Banner Area -->

    <!--================Checkout Area =================-->
    <section class="checkout_area section_gap">
        <div class="container">
            <d?iv>
                <!-- <div class="cupon_area">
                <div class="check_title">
                    <h2>Have a coupon? <a href="#">Click here to enter your code</a></h2>
                </div>
                <input type="text" placeholder="Enter coupon code">
                <a class="tp_btn" href="#">Apply Coupon</a>
            </div> -->
                <div class="billing_details">
                    <div class="row">

                        <div class="col-md-6 ">
                            <div>
                                <%if(locals.data){%>
                                    <h5>Shipping Address</h5>
                                    <%for(i=0;i<data[0].address.length;i++){%>
                                        <input type="radio" id="addressselect" name="addressselect"
                                            value="<%=data[0].address[i]._id%>">
                                        <div class="mt-3 mb-3 bg-light p-2 rounded text-dark">
                                            <div class="d-flex">
                                                <small class="me-4">FullName: <%=data[0].address[i].name%></small>
                                            </div>
                                            <div class="d-flex">
                                                <small class="me-1">Number: <%=data[0].address[i].number%></small>,
                                                <small>Alt Number: <%=data[0].address[i].altNumber%></small>
                                            </div>
                                            <div class="d-flex">
                                                <small>Pincode: <%=data[0].address[i].pinCode%></small>
                                            </div>
                                            <div class="d-flex">
                                                <small>House: <%=data[0].address[i].house%></small>
                                            </div>
                                            <div class="d-flex">
                                                <small class="me-5">Area: <%=data[0].address[i].area%></small>
                                                <small>Landmark: <%=data[0].address[i].landmark%></small>
                                            </div>
                                            <div class="d-flex">
                                                <small class="me-4">Town: <%=data[0].address[i].town%></small>
                                                <small class="me-4">State: <%=data[0].address[i].state%></small>
                                            </div>

                                        </div>

                                        <%}%>
                                            <%}%>
                            </div>

                            <a href="/addAdress"><button class="btn btn-primary"> add address</button></a>

                        </div>




                        <div class="col-md-6 ml-auto">
                            <div class="order_box">
                                <h2>Your Order</h2>
                                <ul class="list list_2">
                                    <%if(locals.total){%>
                                        <li><a href="#">Subtotal <span id="discount2">
                                                    <%=total%>
                                                        <%}%>
                                                </span></a></li>

                                        <input type="radio" name="selector" id="wallet" value="wallet">
                                        <li><a href="#">Wallet Balance <span>
                                                    <%if(locals.data[0]){%>
                                                        <% var totalAmount=0; %>
                                                            <%for(i=0;i<data[0].wallet.length;i++){%>

                                                                <% totalAmount +=data[0].wallet[i].amount; %>

                                                                    <%}%>
                                                                        <div class="mt-2">₹ <%= totalAmount %>
                                                                        </div>
                                                                        <%}%>
                                                </span></a></li>

                                        <button type="button" class="btn btn-outline-primary mt-2"
                                            data-bs-toggle="modal" data-bs-target="#modalCoupon">Available
                                            Coupons</button>
                                        <div class="cupon_text d-flex ml-auto" style="padding-left: 45%;">
                                            <input type="text" placeholder="Coupon Code" id="coupon">
                                            <button class="primary-btn" onClick="coupon()" href="#">Apply</button>


                                        </div>
                                        <li><a href="#">coupon discount <span>
                                                    <div id="code">
                                                        0
                                                    </div>
                                                </span></a></li>

                                        <li><a href="#">Total <span id="discount1">
                                                    <%if(locals.total){%>
                                                        <%=total%>
                                                </span></a></li>
                                        <%}%>
                                </ul>





                                <div class="payment_item">
                                    <div class="radion_btn">
                                        <input type="radio" id="f-option5" name="selector" value="cod">
                                        <label for="f-option5">Cash on Delivery</label>
                                        <div class="check"></div>
                                    </div>
                                    <p>you can also complete payment using online payment methods during
                                        delivery time.</p>
                                </div>
                                <div class="payment_item active">
                                    <div class="radion_btn">
                                        <input type="radio" id="f-option6" name="selector" value="online" checked>
                                        <label for="f-option6">Online Payment </label>
                                        <img src="img/product/card.jpg" alt="">
                                        <div class="check"></div>
                                    </div>
                                    <p>Pay via online; you can pay with your credit card ,debit card or UPI
                                        payments
                                        .</p>
                                </div>
                                <div class="creat_account">
                                    <input type="checkbox" id="f-option4" name="selector">
                                    <label for="f-option4">I’ve read and accept the </label>
                                    <a href="#">terms & conditions*</a>
                                </div>
                                <!-- <a class="primary-btn" href="/confirmation">Proceed to Payment     </a> -->
                                <%if(locals.total){%>
                                    <button class="btn-primary" onclick="makePurchase('<%= total %>')">proceed to
                                        pay</button>
                                <%}%>
                            </div>
                        </div>

                    </div>
                </div>
        </div>
    </section>
    <!--================End Checkout Area =================-->

    <!-- start footer Area -->
    <footer class="footer-area section_gap">
        <div class="container">
            <div class="row">
                <div class="col-lg-3  col-md-6 col-sm-6">
                    <div class="single-footer-widget">
                        <h6>About Us</h6>
                        <p>
                            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt
                            ut labore dolore
                            magna aliqua.
                        </p>
                    </div>
                </div>
                <div class="col-lg-4  col-md-6 col-sm-6">
                    <div class="single-footer-widget">
                        <h6>Newsletter</h6>
                        <p>Stay update with our latest</p>
                        <div class="" id="mc_embed_signup">

                            <form target="_blank" novalidate="true"
                                action="https://spondonit.us12.list-manage.com/subscribe/post?u=1462626880ade1ac87bd9c93a&amp;id=92a4423d01"
                                method="get" class="form-inline">

                                <div class="d-flex flex-row">

                                    <input class="form-control" name="EMAIL" placeholder="Enter Email"
                                        onfocus="this.placeholder = ''" onblur="this.placeholder = 'Enter Email '"
                                        required="" type="email">


                                    <button class="click-btn btn btn-default"><i class="fa fa-long-arrow-right"
                                            aria-hidden="true"></i></button>
                                    <div style="position: absolute; left: -5000px;">
                                        <input name="b_36c4fd991d266f23781ded980_aefe40901a" tabindex="-1" value=""
                                            type="text">
                                    </div>

                                    <!-- <div class="col-lg-4 col-md-4">
													<button class="bb-btn btn"><span class="lnr lnr-arrow-right"></span></button>
												</div>  -->
                                </div>
                                <div class="info"></div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3  col-md-6 col-sm-6">
                    <div class="single-footer-widget mail-chimp">
                        <h6 class="mb-20">Instragram Feed</h6>
                        <ul class="instafeed d-flex flex-wrap">
                            <li><img src="img/i1.jpg" alt=""></li>
                            <li><img src="img/i2.jpg" alt=""></li>
                            <li><img src="img/i3.jpg" alt=""></li>
                            <li><img src="img/i4.jpg" alt=""></li>
                            <li><img src="img/i5.jpg" alt=""></li>
                            <li><img src="img/i6.jpg" alt=""></li>
                            <li><img src="img/i7.jpg" alt=""></li>
                            <li><img src="img/i8.jpg" alt=""></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 col-sm-6">
                    <div class="single-footer-widget">
                        <h6>Follow Us</h6>
                        <p>Let us be social</p>
                        <div class="footer-social d-flex align-items-center">
                            <a href="#"><i class="fa fa-facebook"></i></a>
                            <a href="#"><i class="fa fa-twitter"></i></a>
                            <a href="#"><i class="fa fa-dribbble"></i></a>
                            <a href="#"><i class="fa fa-behance"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer-bottom d-flex justify-content-center align-items-center flex-wrap">
                <p class="footer-text m-0">
                    <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                    Copyright &copy;
                    <script>document.write(new Date().getFullYear());</script> All rights reserved | This template is
                    made with <i class="fa fa-heart-o" aria-hidden="true"></i> by <a href="https://colorlib.com"
                        target="_blank">Colorlib</a>
                    <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                </p>
            </div>
        </div>
    </footer>

    <!-- End footer Area -->


    <div class="modal fade top" id="modalCoupon" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true"
        data-bs-backdrop="true">
        <div class="modal-dialog modal-frame modal-top modal-notify modal-success" role="document">
            <!--Content-->
            <div class="modal-content">
                <!--Body-->
                <div class="modal-body">
                    <% coupons.forEach((coupon, index)=> { %>
                        <div class="row d-flex justify-content-center align-items-center border rounded">
                            <div class="col-12 col-md-12 d-flex">
                                <div class="code-container col-3 col-md-3 d-flex align-items-center">
                                    <p>
                                        <span class="badge" id="couponCode<%= index %>" style="color: black;">
                                            <%= coupon.code %>
                                        </span>
                                    </p>
                                </div>
                                <div class="content-copy-container col-9 col-md-9 d-flex align-items-center">
                                    <p class="pt-3 mx-4">
                                        <%= coupon.description %>
                                            <strong> &#8377;<%= coupon.discountAmount %> discount</strong>.
                                    </p>
                                    <button type="button" class="btn btn-success copy-button ms-auto"
                                        data-index="<%= index %>">
                                        <i class="fas fa-copy ml-1 white-text "></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                            <div class="close-container d-flex justify-content-end mt-2">
                                <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">No,
                                    thanks</button>
                            </div>
                </div>
            </div>
            <!--/.Content-->
        </div>
    </div>









    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const copyButtons = document.querySelectorAll(".copy-button");

            copyButtons.forEach(copyButton => {
                copyButton.addEventListener("click", function () {
                    const couponCode = this.closest(".row").querySelector(".badge").textContent.trim();
                    copyToClipboard(couponCode);
                    updateCopyButton(this); // Update the clicked copy button's appearance
                    const modal = document.getElementById('modalCoupon');
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    modalInstance.hide(); // Close the modal after copying
                });
            });
        });

        function updateCopyButton(button) {
            button.innerHTML = '<i class="fas fa-check ml-1 white-text"></i>';
            button.disabled = true; // Disable the button after copying
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
            } catch (error) {
                console.error("Failed to copy:", error);
            }
        }

        function makePurchase(GrandTotal) {


            let addressId = $("#addressselect:checked").val();
            console.log(addressId);
            // let payment = $(".radio:checked").val();
            let codbutton = document.getElementById("f-option5")
            let onlinebutton = document.getElementById("f-option6")
            let walletbutton = document.getElementById("wallet")
            let payment
            if (codbutton.checked) {
                payment = codbutton.value
            } else if (onlinebutton.checked) {
                payment = onlinebutton.value
            } else if (walletbutton.checked) {
                payment = walletbutton.value
            }
            console.log(payment);

            $.ajax({
                url: '/confirmation',
                method: 'post',
                data: {
                    addressId: addressId,
                    payment: payment,
                    GrandTotal: document.getElementById("discount1").innerText,
                    discount: document.getElementById("code").innerText

                },
                success: (response) => {
                    // console.log(response.status)

                    if (response.method == 'cod') {
                        console.log("heloooooooooooooo");
                        Swal.fire({
                            title: "Order success",
                            text: "order placed successfully",
                            icon: "success",
                            showCancelButton: true,
                            confirmButtonText: "view orders",
                            cancelButtonText: "continue shopping",
                            reverseButtons: true
                        })
                        .then(function (result) {
                            if (result.value) {
                        location.href = '/Account'
                            } else if (result.dismiss === "cancel") {
                                location.href = '/productList'
                            }
                        });

                    } else if (response.method == 'online') {
                        var options = {
                            "key": "rzp_test_80jNgNYgTgs47P", // Enter the Key ID generated from the Dashboard
                            "amount": response.order.finalAmount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                            "currency": "INR",
                            "name": "SHOE CART", //your business name
                            "description": "Test Transaction",
                            "image": "https://example.com/your_logo",
                            "order_id": response.razorpayOrder.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                            "handler": function (status) {

                                verifyPayment(response, status)
                            },
                            "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information, especially their phone number
                                "name": "Gaurav Kumar", //your customer's name
                                "email": "gaurav.kumar@example.com",
                                "contact": "9000090000"  //Provide the customer's phone number for better conversion rates 
                            },
                            "notes": {
                                "address": "Razorpay Corporate Office"
                            },
                            "theme": {
                                "color": "#3399cc"
                            }
                        };
                        var rzp1 = new Razorpay(options);
                        rzp1.open();


                    } else {
                        Swal.fire({
                            title: 'Error Occured',
                            text: "Can't process order error occured",
                            icon: 'fail',
                            timer: 5000
                        })

                    }
                }
            })
        }

        function verifyPayment(order, payment) {
            $.ajax({
                url: '/verifyPayment',
                method: 'post',
                data: {
                    order,
                    payment
                },
                success: (response) => {
                    if (response.status) {
                        Swal.fire({
                            title: "Order success",
                            text: "order placed successfully",
                            icon: "success",
                            showCancelButton: true,
                            confirmButtonText: "view orders",
                            cancelButtonText: "continue shopping",
                            reverseButtons: true
                        })
                        .then(function (result) {
                            if (result.value) {
                        location.href = '/Account'
                            } else if (result.dismiss === "cancel") {
                                location.href = '/productList'
                            }
                        });
                    } else {
                        alert("Payment failed!" + response.errMsg)
                    }
                }
            })
        }
    </script>


    <script>
        function coupon() {

            const discount = document.getElementById("coupon").value
            const sub = document.getElementById("discount2")
            const total = document.getElementById("discount1")


            console.log(discount);
            $.ajax({
                url: '/coupon',
                method: 'post',
                data: {
                    discount,

                },
                success: (response) => {
                    document.getElementById("code").innerText = response.coupon.discountAmount
                    total.innerText = Number(sub.innerText) - response.coupon.discountAmount

                }
            })
        }
    </script>






    <script src="js/vendor/jquery-2.2.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
        integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
        crossorigin="anonymous"></script>
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/jquery.ajaxchimp.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery.sticky.js"></script>
    <script src="js/nouislider.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <!--gmaps Js-->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
    <script src="js/gmaps.min.js"></script>
    <script src="js/main.js"></script>
</body>

</html>